events {
    worker_connections 1024;
}

http {
    types {
        text/html                             html htm;
        text/css                              css;
        application/javascript                js;
        application/json                      json;
        image/jpeg                            jpg jpeg;
        image/png                             png;
        image/gif                             gif;
        image/svg+xml                         svg svgz;
        font/truetype                         ttf;
        font/opentype                         otf;
        application/font-woff                 woff;
        application/font-woff2                woff2;
        image/x-icon                          ico;
    }

    default_type application/octet-stream;

    server {
        listen 80;
        root /usr/share/nginx/html;
        index index.html;

        # Enable gzip compression
        gzip on;
        gzip_types text/plain text/css text/javascript application/javascript application/json;
        gzip_min_length 1024;

        # Proxy API calls to backend container so browser-served SPA can call APIs
        location /api/ {
            proxy_pass http://backend:8080/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Proxy OpenAPI/Swagger API docs to backend
        location /v3/api-docs/ {
            proxy_pass http://backend:8080/v3/api-docs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Proxy Swagger UI assets (if backend serves them)
        location /swagger-ui/ {
            proxy_pass http://backend:8080/swagger-ui/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # SPA routing: Rewrite all other requests to index.html except for assets
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|otf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }

        # Never cache HTML
        location ~* \.html?$ {
            expires -1;
            add_header Cache-Control "public, no-cache, no-store, must-revalidate";
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "OK";
            add_header Content-Type text/plain;
        }
    }
}
